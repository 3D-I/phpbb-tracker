<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.0.1.xsd">
	<header>
		<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
		<title lang="en">phpBB Tracker</title>
		<description lang="en">Full tracker add-on for phpBB 3.0.x</description>
		<author-group>
			<author>
				<realname>J. Russo</realname>
				<email>jrsweets@gmail.com</email>
				<username>JRSweets</username>
				<homepage>http://www.jeffrusso.net</homepage>
				<contributions />
			</author>
		</author-group>
		<mod-version>
			<major>0</major>
			<minor>1</minor>
			<revision>0</revision>
		</mod-version>
		<installation>
			<level>easy</level>
			<time>373</time>
			<target-version>
				<target-primary>3.0.0</target-primary>
				<target-major allow="exact">3</target-major>
				<target-minor allow="exact">0</target-minor>
				<target-revision allow="exact">0</target-revision>
			</target-version>
		</installation>
		<history>
			<entry>
				<date>2008-02-04</date>
				<rev-version>
					<major>0</major>
					<minor>1</minor>
					<revision>0</revision>
				</rev-version>
				<changelog lang="en">
					<change>Initial Beta Release</change>
				</changelog>
			</entry>
		</history>
	</header>
	<action-group>
		<copy>
			<file from="root/tracker.php" to="tracker.php" />
			<file from="root/adm/style/acp_tracker.html" to="adm/style/acp_tracker.html" />
			<file from="root/tracker_install/*.*" to="tracker_install/*.*" />
			<file from="root/includes/acp/acp_tracker.php" to="includes/acp/acp_tracker.php" />
			<file from="root/includes/acp/info/acp_tracker.php" to="includes/acp/info/acp_tracker.php" />
			<file from="root/includes/tracker/tracker_class.php" to="includes/tracker/tracker_class.php" />
			<file from="root/includes/tracker/tracker_constants.php" to="includes/tracker/tracker_constants.php" />
			<file from="root/language/en/acp/permissions_tracker.php" to="language/en/acp/permissions_tracker.php" />
			<file from="root/language/en/email/tracker_notify.txt" to="language/en/email/tracker_notify.txt" />
			<file from="root/language/en/email/tracker_notify_comment.txt" to="language/en/email/tracker_notify_comment.txt" />
			<file from="root/language/en/email/tracker_notify_status_double.txt" to="language/en/email/tracker_notify_status_double.txt" />
			<file from="root/language/en/email/tracker_notify_status_single.txt" to="language/en/email/tracker_notify_status_single.txt" />
			<file from="root/language/en/mods/tracker.php" to="language/en/mods/tracker.php" />
			<file from="root/language/en/mods/info_acp_tracker.php" to="language/en/mods/info_acp_tracker.php" />
			<file from="root/styles/prosilver/template/tracker/tracker_index_body.html" to="styles/prosilver/template/tracker/tracker_index_body.html" />
			<file from="root/styles/prosilver/template/tracker/tracker_tickets_add_body.html" to="styles/prosilver/template/tracker/tracker_tickets_add_body.html" />
			<file from="root/styles/prosilver/template/tracker/tracker_tickets_body.html" to="styles/prosilver/template/tracker/tracker_tickets_body.html" />
			<file from="root/styles/prosilver/template/tracker/tracker_tickets_view_body.html" to="styles/prosilver/template/tracker/tracker_tickets_view_body.html" />
			<file from="root/styles/prosilver/template/tracker/tracker_header.html" to="styles/prosilver/template/tracker/tracker_header.html" />
			<file from="root/styles/subsilver2/template/tracker/tracker_breadcrumbs.html" to="styles/subsilver2/template/tracker/tracker_breadcrumbs.html" />
			<file from="root/styles/subsilver2/template/tracker/tracker_index_body.html" to="styles/subsilver2/template/tracker/tracker_index_body.html" />
			<file from="root/styles/subsilver2/template/tracker/tracker_tickets_add_body.html" to="styles/subsilver2/template/tracker/tracker_tickets_add_body.html" />
			<file from="root/styles/subsilver2/template/tracker/tracker_tickets_body.html" to="styles/subsilver2/template/tracker/tracker_tickets_body.html" />
			<file from="root/styles/subsilver2/template/tracker/tracker_tickets_view_body.html" to="styles/subsilver2/template/tracker/tracker_tickets_view_body.html" />
			<file from="root/styles/subsilver2/template/tracker/tracker_header.html" to="styles/subsilver2/template/tracker/tracker_header.html" />
		</copy>
		<open src="includes/functions.php">
			<edit>
				<find>function page_header($page_title = '', $display_online_list = true)
{
	global $db, $config, $template, $SID, $_SID, $user, $auth, $phpEx, $phpbb_root_path;</find>
				<action type="after-add">	global $tracker;</action>
			</edit>
			<edit>
				<find>// The following assigns all _common_ variables that may be used at any point in a template.</find>
				<action type="after-add"><![CDATA[	if (!isset($tracker))
	{
		$user->add_lang('mods/tracker');
		$template->assign_var('U_TRACKER', append_sid("{$phpbb_root_path}tracker.$phpEx"));
	}]]></action>
			</edit>
		</open>
		<open src="viewonline.php">
			<edit>
				<find><![CDATA[		case 'ucp':
			$location = $user->lang['VIEWING_UCP'];

			// Grab some common modules
			$url_params = array(
				'mode=register'		=> 'VIEWING_REGISTER',
				'i=pm&mode=compose'	=> 'POSTING_PRIVATE_MESSAGE',
				'i=pm&'				=> 'VIEWING_PRIVATE_MESSAGES',
				'i=profile&'		=> 'CHANGING_PROFILE',
				'i=prefs&'			=> 'CHANGING_PREFERENCES',
			);

			foreach ($url_params as $param => $lang)
			{
				if (strpos($row['session_page'], $param) !== false)
				{
					$location = $user->lang[$lang];
					break;
				}
			}

			$location_url = append_sid("{$phpbb_root_path}index.$phpEx");
		break;]]></find>
				<action type="after-add"><![CDATA[		case 'tracker':				
			if (!isset($tracker))
			{	
				include($phpbb_root_path . 'includes/tracker/tracker_class.' . $phpEx);
				$tracker = new tracker();
			}			
			
			// Grab some common modules
			$url_params = array(
				'mode=statistics'	=> 'VIEWING_TRACKER_STATISTICS',
				'mode=add'			=> 'ADDING_TRACKER_TICKET',
				'mode=reply'		=> 'REPLYING_TRACKER_TICKET',
			);
			
			preg_match('#p=([0-9]+)#i', $row['session_page'], $project_id);
			$project_id = (sizeof($project_id)) ? (int) $project_id[1] : 0;
			
			preg_match('#t=([0-9]+)#i', $row['session_page'], $ticket_id);
			$ticket_id = (sizeof($ticket_id)) ? (int) $ticket_id[1] : 0;

			$found_tracker = false;
			foreach ($url_params as $param => $lang)
			{
				if (strpos($row['session_page'], $param) !== false)
				{
					if ($param == 'mode=statistics')
					{
						$found_tracker = true;
						if ($project_id)
						{
							$location = sprintf($user->lang[$lang], $tracker->get_type_option('title', $project_id), $tracker->projects[$project_id]['project_name']);
							$location_url = append_sid("{$phpbb_root_path}tracker.$phpEx", 'mode=statistics&amp;p=' . $project_id);
						}
						else
						{
							$location = sprintf($user->lang[$lang . '_ALL']);
							$location_url = append_sid("{$phpbb_root_path}tracker.$phpEx", 'mode=statistics');
						}
					}
					else if ($param == 'mode=add' && $project_id)
					{						
						$found_tracker = true;
						$location = sprintf($user->lang[$lang], $tracker->get_type_option('title', $project_id), $tracker->projects[$project_id]['project_name']);
						$location_url = append_sid("{$phpbb_root_path}tracker.$phpEx", 'p=' . $project_id);					
					}
					else if ($param == 'mode=reply' && $project_id && $ticket_id)
					{
						$found_tracker = true;
						$location = sprintf($user->lang[$lang], $tracker->get_type_option('title', $project_id), $tracker->projects[$project_id]['project_name']);
						$location_url = append_sid("{$phpbb_root_path}tracker.$phpEx", 'p=' . $project_id . '&amp;t=' . $ticket_id);					
					}
					break;
				}
			}
			
			if (!$found_tracker)
			{
				$lang = 'VIEWING_TRACKER';
				if ($project_id && $ticket_id)
				{
					$location = sprintf($user->lang[$lang . '_TICKET'], $tracker->get_type_option('title', $project_id), $tracker->projects[$project_id]['project_name']);
					$location_url = append_sid("{$phpbb_root_path}tracker.$phpEx", 'p=' . $project_id . '&amp;t=' . $ticket_id);	
				}
				else if ($project_id && !$ticket_id)
				{
					$location = sprintf($user->lang[$lang . '_PROJECT'], $tracker->get_type_option('title', $project_id), $tracker->projects[$project_id]['project_name']);
					$location_url = append_sid("{$phpbb_root_path}tracker.$phpEx", 'p=' . $project_id);	
				}
				else
				{
					$location = $user->lang[$lang];
					$location_url = append_sid("{$phpbb_root_path}tracker.$phpEx");
				}
			}
		break;]]></action>
			</edit>
		</open>
		<diy-instructions lang="en">CHMOD to 755 or 777 the includes/tracker/files directory.
Run the included installer at http://yoursite.com/phpBB/tracker_install/install.php
Once done make sure to remove tracker_install folder from your server.</diy-instructions>
	</action-group>
</mod>